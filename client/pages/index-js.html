<script>

    let eventFeedArray

    function loadFeed() {
        createCategories()
        show()
        google.script.run
            .withSuccessHandler(renderFeed)
            .withFailureHandler(handleError)
            .loadFeed();
    }

    function handleError(error) {
        console.error('Error fetching data:', error);
    }

    function renderFeed(feedString) {
        const { eventsFeed } = JSON.parse(feedString)
        eventFeedArray = eventsFeed
        // populateEvents(eventsFeed)
        populateEvents()
        hide()
    }

    // PLUS BUTTON

    document.getElementById('plus-button').addEventListener('click', function () {
        showModal('modal-form');
    });

    function closeAllModals() {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            modal.style.display = 'none';
        });
    }

    window.onclick = function (event) {
        // Check if the clicked element is a modal and not the modal-content
        if (event.target.classList.contains('modal')) {
            // Add a condition to check for non-closable modals by ID
            if (event.target.id === "modal-loading") {
                // If it's the loading modal, do not close it
                return;
            }
            closeModal(event.target.id);
        }
    }

    //// RUN SUBMIT BUTTON

    // BACKEND FUNCTIONS GAS

    function createEventInfraStructure(request) {
        showModal('modal-loading');
        showLoadingText('Preparing your event...');
        google.script.run
            .withSuccessHandler(addEventToDB)
            .withFailureHandler(handleError)
            .createEventInfraStructure(request);
    }

    function addEventToDB(request) {
        showLoadingText('Almost ready...');
        // Formulate Add to DB Request
        google.script.run
            .withSuccessHandler(showSuccess)
            .withFailureHandler(handleError)
            .addEventToDB(request);
    }

    function changeTextUnderLoading() {
        const loadingModalText = document.getElementById("loadingModalText")
    }

    async function showSuccess(eventData) {
        closeAllModals(); // Close all modals when operation is successful
        showModal('confetti-wrapper');
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 }
        });
        await wait(3000); // Show confetti for 3 seconds
        closeModal('confetti-wrapper');
    }

    // EMULATION

    // Helper function to wait for a specified amount of time using Promises
    function wait(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function handleFormSubmission() {
        document.getElementById('event-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            showModal('modal-loading');

            showLoadingText('Preparing your event...');
            console.log('Preparing your event...')
            await wait(5000); // Display first message for 2 seconds
            console.log('Prepared')
            showLoadingText('Almost ready...');
            console.log('Almost ready...')
            await wait(5000); // Display second message for 2 seconds
            // hideLoadingText()
            console.log('Readied!')
            closeAllModals(); // Close all modals when operation is successful
            showModal('confetti-wrapper');
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });

            await wait(3000); // Show confetti for 3 seconds
            closeModal('confetti-wrapper');
        });
    }

    handleFormSubmission()
    window.onload = loadFeed;

</script>